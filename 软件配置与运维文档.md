# DuckStudy 软件配置与运维文档

## 1. 项目概述

### 1.1 项目信息
- **项目名称**: DuckStudy 综合学习平台
- **版本**: 1.0.0
- **技术栈**: Python Flask + Vanilla JavaScript + Bootstrap
- **部署方式**: 单体应用部署

### 1.2 系统架构
```
前端 (Static Files)
    ↓
Flask 后端服务
    ↓
JSON 文件存储 + 文件系统存储
```

## 2. 配置管理

### 2.1 环境配置

#### 2.1.1 环境变量配置
创建 `.env` 文件在 `backend/` 目录下：

```bash
# Flask 配置
FLASK_SECRET_KEY=your-secret-key-here
FLASK_ENV=production
FLASK_DEBUG=False

# GitHub API 配置
GITHUB_TOKEN=your-github-token-here

# 数据库配置（如后续使用）
DATABASE_URL=sqlite:///duckstudy.db

# 文件上传配置
MAX_CONTENT_LENGTH=2097152  # 2MB
UPLOAD_FOLDER=frontend/images/posts

# 安全配置
SESSION_COOKIE_SECURE=True
SESSION_COOKIE_HTTPONLY=True
```

#### 2.1.2 配置文件结构
```
backend/
├── .env                    # 环境变量（不提交到版本控制）
├── config/
│   ├── __init__.py
│   └── config.py          # 配置类
├── requirements.txt       # Python 依赖
└── app.py                # 主应用文件
```

### 2.2 依赖管理

#### 2.2.1 Python 依赖
```bash
# 安装依赖
pip install -r backend/requirements.txt

# 更新依赖
pip freeze > backend/requirements.txt
```

#### 2.2.2 Node.js 依赖
```bash
# 安装开发依赖
npm install

# 运行测试
npm test
npm run test:coverage
```

## 3. 版本控制

### 3.1 Git 配置

#### 3.1.1 .gitignore 文件
```gitignore
# 环境变量
.env
.env.local
.env.production

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
.venv/
pip-log.txt
pip-delete-this-directory.txt

# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# 测试覆盖率
.coverage
tests/coverage/
.coveragerc

# IDE
.vscode/
.idea/
*.swp
*.swo

# 操作系统
.DS_Store
Thumbs.db

# 日志文件
*.log

# 临时文件
*.tmp
*.temp
```

#### 3.1.2 分支策略
- **main**: 主分支，用于生产环境
- **develop**: 开发分支，用于集成测试
- **feature/***: 功能分支，用于新功能开发
- **hotfix/***: 热修复分支，用于紧急修复

#### 3.1.3 提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建过程或辅助工具的变动
```

### 3.2 版本发布

#### 3.2.1 版本号规范
采用语义化版本控制 (SemVer)：
- **主版本号**: 不兼容的API修改
- **次版本号**: 向下兼容的功能性新增
- **修订号**: 向下兼容的问题修正

#### 3.2.2 发布流程
1. 创建发布分支
2. 更新版本号
3. 更新CHANGELOG
4. 合并到main分支
5. 创建Git标签

## 4. 持续集成

### 4.1 测试配置

#### 4.1.1 Jest 测试配置
```javascript
// jest.config.js
module.exports = {
  testEnvironment: "jsdom",
  testMatch: ["**/tests/frontend/**/*.test.js"],
  collectCoverageFrom: [
    "frontend/js/**/*.js",
    "!frontend/js/lib/**/*.js"
  ],
  coverageDirectory: "tests/coverage",
  coverageReporters: ["json", "lcov", "text", "html"],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 75,
      lines: 80,
      statements: 80
    }
  }
};
```

#### 4.1.2 Python 测试配置
```python
# tests/conftest.py
import pytest
import sys
import os

# 添加项目根目录到Python路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

@pytest.fixture
def client():
    from backend.app import app
    app.config['TESTING'] = True
    with app.test_client() as client:
        yield client
```

### 4.2 CI/CD 流程

#### 4.2.1 GitHub Actions 配置
创建 `.github/workflows/ci.yml`：

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Install Python dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install pytest pytest-cov
    
    - name: Install Node.js dependencies
      run: npm install
    
    - name: Run Python tests
      run: |
        cd tests
        pytest --cov=backend --cov-report=xml
    
    - name: Run JavaScript tests
      run: npm test
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./tests/coverage.xml
        flags: python
        name: python-coverage

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to production
      run: |
        echo "部署到生产环境"
        # 这里添加实际的部署脚本
```

## 5. 部署方案

### 5.1 开发环境部署

#### 5.1.1 本地开发环境
```bash
# 1. 克隆项目
git clone https://github.com/yourusername/DuckStudy.git
cd DuckStudy

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows

# 3. 安装依赖
pip install -r backend/requirements.txt
npm install

# 4. 配置环境变量
cp backend/.env.example backend/.env
# 编辑 .env 文件

# 5. 启动服务
python backend/app.py
```

#### 5.1.2 Docker 开发环境
```dockerfile
# Dockerfile.dev
FROM python:3.9-slim

WORKDIR /app

COPY backend/requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 5000

CMD ["python", "backend/app.py"]
```

```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  duckstudy:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "5000:5000"
    volumes:
      - .:/app
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=True
```

### 5.2 生产环境部署

#### 5.2.1 传统服务器部署
```bash
# 1. 服务器环境准备
sudo apt update
sudo apt install python3 python3-pip nginx

# 2. 创建应用用户
sudo useradd -m -s /bin/bash duckstudy
sudo su - duckstudy

# 3. 部署应用
git clone https://github.com/yourusername/DuckStudy.git
cd DuckStudy
python3 -m venv venv
source venv/bin/activate
pip install -r backend/requirements.txt

# 4. 配置环境变量
cp backend/.env.example backend/.env
# 编辑生产环境配置

# 5. 配置 Gunicorn
pip install gunicorn
```

#### 5.2.2 Gunicorn 配置
```python
# gunicorn.conf.py
bind = "127.0.0.1:8000"
workers = 4
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 100
preload_app = True
```

#### 5.2.3 Nginx 配置
```nginx
# /etc/nginx/sites-available/duckstudy
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static/ {
        alias /home/duckstudy/DuckStudy/frontend/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /images/ {
        alias /home/duckstudy/DuckStudy/frontend/images/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 5.2.4 Systemd 服务配置
```ini
# /etc/systemd/system/duckstudy.service
[Unit]
Description=DuckStudy Flask Application
After=network.target

[Service]
User=duckstudy
Group=duckstudy
WorkingDirectory=/home/duckstudy/DuckStudy
Environment="PATH=/home/duckstudy/DuckStudy/venv/bin"
ExecStart=/home/duckstudy/DuckStudy/venv/bin/gunicorn -c gunicorn.conf.py app:app
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always

[Install]
WantedBy=multi-user.target
```

### 5.3 容器化部署

#### 5.3.1 Docker 生产镜像
```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY backend/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建非root用户
RUN useradd -m -u 1000 duckstudy && \
    chown -R duckstudy:duckstudy /app
USER duckstudy

EXPOSE 8000

CMD ["gunicorn", "-c", "gunicorn.conf.py", "backend.app:app"]
```

#### 5.3.2 Docker Compose 生产配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  duckstudy:
    build: .
    ports:
      - "8000:8000"
    environment:
      - FLASK_ENV=production
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    volumes:
      - ./frontend/images:/app/frontend/images
      - ./frontend/data:/app/frontend/data
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - duckstudy
    restart: unless-stopped
```

## 6. 运维计划

### 6.1 监控方案

#### 6.1.1 应用监控
- **日志监控**: 使用 Python logging 模块
- **性能监控**: 集成 Flask-Monitoring
- **错误监控**: 使用 Sentry 或类似服务

#### 6.1.2 系统监控
- **服务器监控**: CPU、内存、磁盘使用率
- **网络监控**: 响应时间、带宽使用
- **数据库监控**: 连接数、查询性能

### 6.2 备份策略

#### 6.2.1 数据备份
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/duckstudy"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据文件
tar -czf $BACKUP_DIR/data_$DATE.tar.gz \
    frontend/data/ \
    frontend/images/

# 保留最近30天的备份
find $BACKUP_DIR -name "data_*.tar.gz" -mtime +30 -delete
```

#### 6.2.2 自动备份计划
```bash
# 添加到 crontab
0 2 * * * /path/to/backup.sh
```

### 6.3 安全措施

#### 6.3.1 网络安全
- 使用 HTTPS
- 配置防火墙
- 限制 SSH 访问
- 定期更新系统

#### 6.3.2 应用安全
- 输入验证和过滤
- SQL 注入防护
- XSS 防护
- CSRF 防护
- 文件上传安全

### 6.4 故障恢复

#### 6.4.1 故障检测
```bash
#!/bin/bash
# health_check.sh
URL="http://localhost:8000/api/health"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL)

if [ $RESPONSE -ne 200 ]; then
    echo "服务异常，HTTP状态码: $RESPONSE"
    # 发送告警通知
    # 重启服务
    systemctl restart duckstudy
fi
```

#### 6.4.2 恢复流程
1. **故障识别**: 监控系统告警
2. **影响评估**: 确定影响范围
3. **应急处理**: 快速恢复服务
4. **根本原因分析**: 分析故障原因
5. **预防措施**: 制定预防方案

### 6.5 性能优化

#### 6.5.1 前端优化
- 静态资源压缩
- 图片优化
- 缓存策略
- CDN 加速

#### 6.5.2 后端优化
- 数据库查询优化
- 缓存机制
- 异步处理
- 负载均衡

## 7. 维护计划

### 7.1 定期维护

#### 7.1.1 日常维护
- 日志清理
- 临时文件清理
- 监控检查

#### 7.1.2 周维护
- 安全更新
- 性能检查
- 备份验证

#### 7.1.3 月维护
- 系统更新
- 依赖更新
- 容量规划

### 7.2 升级计划

#### 7.2.1 版本升级流程
1. **准备阶段**: 测试环境验证
2. **备份阶段**: 完整数据备份
3. **升级阶段**: 执行升级脚本
4. **验证阶段**: 功能验证
5. **回滚准备**: 准备回滚方案

#### 7.2.2 回滚策略
- 代码回滚
- 数据库回滚
- 配置回滚

## 8. 文档维护

### 8.1 文档更新
- 代码变更时同步更新文档
- 定期审查文档准确性
- 版本发布时更新文档

### 8.2 知识管理
- 建立知识库
- 记录常见问题
- 分享最佳实践

---

**文档版本**: 1.0  
**最后更新**: 2024年12月  
**维护人员**: 开发团队 